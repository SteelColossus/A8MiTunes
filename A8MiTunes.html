<!DOCTYPE html>
<html>
	<head>
		<title>A8MiTunes</title>
		<link rel="stylesheet" href="styles.css" />
		<script type="text/javascript" src="music.js"></script>
		<script type="text/javascript">
		document.addEventListener("keydown", function(event) {
			var key = document.getElementById("key" + event.key.substring(0, 1).toUpperCase() + event.key.substring(1));
			
			if (key != null)
			{
				key.click();
			}
			else if (event.keyCode == 8) // backspace
			{
				document.getElementById("keyBack").click();
			}
			else if (event.keyCode == 32) // space
			{
				document.getElementById("keySpace").click();
			}
			else if (event.keyCode == 13) // enter
			{			
				var audioControl = document.getElementById("audioControl");
				
				audioControl.paused ? audioControl.play() : audioControl.pause();
			}
		});
		
		function filterAlbumList(albumList, searchTxt)
		{
			var filteredAlbumList = [];
			
			for (var i in albumList)
			{				
				if (filterSongList(albumList[i].tracks, searchTxt).length > 0)
				{
					filteredAlbumList[filteredAlbumList.length] = albumList[i];
				}
			}
			
			return filteredAlbumList;
		}
		
		function filterSongList(songList, searchTxt)
		{
			var searchParameters = document.getElementById("searchParameters").value;
		
			var filteredSongList = [];
		
			for (var i in songList)
			{
				if ((searchParameters == "Title" || searchParameters == "TitleLyrics") && songList[i].title.toUpperCase().includes(searchTxt.toUpperCase()))
				{
					filteredSongList[filteredSongList.length] = songList[i];
				}
				else if ((searchParameters == "Lyrics" || searchParameters == "TitleLyrics") && songList[i].lyrics.toUpperCase().includes(searchTxt.toUpperCase()))
				{
					filteredSongList[filteredSongList.length] = songList[i];
				}
			}
			
			return filteredSongList;
		}
		
		function nextSong()
		{
			var songList = document.getElementById("songList");
			
			var shuffle = false;

			if (shuffle)
			{
				var rand = songList.selectedIndex;
				var count = 0;
				
				do
				{
					rand = Math.floor(Math.random() * songList.length);
					count++;
				}
				while (rand == songList.selectedIndex && count < 10)
				
				songList.selectedIndex = rand;
			}
			else
			{
				if (songList.selectedIndex >= songList.length - 1) return;
			
				songList.selectedIndex = songList.selectedIndex + 1;
			}
			
			updateRightPane();
				
			document.getElementById("audioControl").play();
		}
		
		function getID(albumName)
		{
			return albumName.replace(/ /gi, "").toLowerCase();
		}
		
		function clearSelect(x)
		{
			x.innerHTML = "";
		}
		
		function addToSearch(s)
		{
			var searchBar = document.getElementById("searchBar");
			
			var currentText = searchBar.getAttribute("value");
			
			var newText = (currentText == null) ? s : currentText + s;
			
			searchBar.setAttribute("value", newText);
			
			updateSearch();
		}
		
		function backspace()
		{
			var searchBar = document.getElementById("searchBar");
			
			var currentText = searchBar.getAttribute("value");
			
			var newText = (currentText == null) ? s : currentText.substring(0, currentText.length - 1);
			
			searchBar.setAttribute("value", newText);
			
			updateSearch();
		}
		
		function clearSearch()
		{
			var searchBar = document.getElementById("searchBar");
			
			searchBar.setAttribute("value", "");
			
			updateSearch();
		}
		
		function space()
		{
			var searchBar = document.getElementById("searchBar");
			
			var currentText = searchBar.getAttribute("value");
			
			var newText = (currentText == null) ? currentText : currentText + " ";
			
			searchBar.setAttribute("value", newText);
			
			updateSearch();
		}
		
		function updateSearch()
		{
			var albumValue = document.getElementById("albumList").value;
			var songValue = document.getElementById("songList").value;
		
			updateLeftPane();
			
			var newAlbumList = document.getElementById("albumList");
			
			var aValueIndex = -1;
			
			if (albumValue != null)
			{
				for (var a in newAlbumList.options)
				{
					if (newAlbumList.options[a].value == albumValue)
					{
						aValueIndex = a;
						break;
					}
				}

				if (aValueIndex >= 0) newAlbumList.selectedIndex = aValueIndex.toString();
			}
			
			updateCenterPane();
			
			var newSongList = document.getElementById("songList");
			
			var sValueIndex = -1;
			
			if (songValue != null)
			{
				for (var s in newSongList.options)
				{
					if (newSongList.options[s].value == songValue)
					{
						sValueIndex = s;
						break;
					}
				}

				if (sValueIndex >= 0) newSongList.selectedIndex = sValueIndex.toString();
			}
		}
		
		function updateLeftPane()
		{		
			var albumList = document.getElementById("albumList");
			
			var searchBar = document.getElementById("searchBar");
			
			clearSelect(albumList);
			
			var sortedAlbums = albums.slice(0);
			
			sortedAlbums.sort(function (a, b) {
				return a.artist > b.artist ? 1 : -1;
			});
			
			var filteredAlbums;
			
			if (searchBar != null && searchBar.value.length > 1)
			{
				filteredAlbums = filterAlbumList(sortedAlbums, searchBar.value);
			}
			else
			{
				filteredAlbums = sortedAlbums;
			}
			
			var artistGroups = [];
			
			for (var i in filteredAlbums)
			{				
				var a = filteredAlbums[i];
				
				var optionGroup;
				
				var index = artistGroups.indexOf(a.artist);
				
				if (index == -1)
				{
					optionGroup = document.createElement("OPTGROUP");
					optionGroup.setAttribute("id", a.artist + "grp");
					optionGroup.setAttribute("label", a.artist);
					albumList.add(optionGroup);
					artistGroups.push(a.artist);
				}
				else
				{
					optionGroup = document.getElementById(artistGroups[index] + "grp");
				}
				
				var option = document.createElement("OPTION");
				var text = document.createTextNode(a.title);
				option.setAttribute("value", getID(a.title));
				option.setAttribute("id", getID(a.title));
				option.appendChild(text);
				optionGroup.appendChild(option);
			}
		}
		
		function updateCenterPane()
		{
			var albumList = document.getElementById("albumList");
			var songList = document.getElementById("songList");
			var albumTracks = [];
			
			var searchBar = document.getElementById("searchBar");
			
			for (var i in albums)
			{
				var a = albums[i];
				
				if (getID(a.title) == albumList.value)
				{
					albumTracks = a.tracks;
				}
			}
			
			clearSelect(songList);
			
			var filteredTracks;
			
			if (searchBar != null && searchBar.value.length > 1)
			{
				filteredTracks = filterSongList(albumTracks, searchBar.value);
			}
			else
			{
				filteredTracks = albumTracks;
			}
			
			for (var i in filteredTracks)
			{
				var t = filteredTracks[i];
				var option = document.createElement("OPTION");
				var text = document.createTextNode(t.title);
				option.setAttribute("value", getID(t.title));
				option.appendChild(text);
				songList.add(option);
			}
		}
		
		function updateRightPane()
		{
			var currentAlbum = document.getElementById("albumList").value;
			var currentSong = document.getElementById("songList").value;
		
			var albumArt = document.getElementById("albumArt");
			var songName = document.getElementById("songName");
			var songAlbum = document.getElementById("songAlbum");
			var songArtist = document.getElementById("songArtist");
			
			var sourceMP3 = document.getElementById("sourceMP3");
			var sourceWAV = document.getElementById("sourceWAV");
			var audioControl = document.getElementById("audioControl");
			
			songName.innerHTML = "";
			songAlbum.innerHTML = "";
			songArtist.innerHTML = "";
			
			for (var i in albums)
			{
				var a = albums[i];
				
				if (getID(a.title) == currentAlbum)
				{
					songAlbum.appendChild(document.createTextNode(a.title));
					songArtist.appendChild(document.createTextNode(a.artist));
					
					var artPath = "artwork/" + a.artwork + ".jpg";
					
					albumArt.setAttribute("src", artPath);
					
					for (var j in a.tracks)
					{
						var s = a.tracks[j];
										
						if (getID(s.title) == currentSong)
						{
							songName.appendChild(document.createTextNode(s.title));
							
							var path = "audio/" + a.artist + "/" + a.title + "/";
							var songFile = path + s.mp3.substring(0, s.mp3.lastIndexOf("."));
							
							sourceMP3.setAttribute("src", songFile + ".mp3");
							sourceWAV.setAttribute("src", songFile + ".wav");
							
							audioControl.load();
							
							break;
						}
					}
					
					break;
				}
			}
		}
		
		function generateKeyboardControlPanel()
		{		
			var bottomPane = document.getElementById("fullKeyboard");
			var newElement;
			
			var keyLayout = {"Back":"Backspace", "Clear":"Clear", "Space":"Space"};
			
			newElement = document.createElement("DIV");
			
			newElement.setAttribute("id", "controlBoard");
			
			for (var key in keyLayout)
			{			
				var value = keyLayout[key];
			
				var rowElement = document.createElement("DIV");
				
				var cellElement = document.createElement("SPAN");
			
				cellElement.setAttribute("class", "keyboardCell controlCell");
				
				var buttonElement = document.createElement("INPUT");
				var buttonElement = document.createElement("INPUT");
				buttonElement.setAttribute("type", "button");
				buttonElement.setAttribute("id", "key" + key);
				buttonElement.setAttribute("value", value);
				buttonElement.setAttribute("class", "keyboardButton controlButton");
				
				var assFunction;
				
				switch (key)
				{
					case "Back": assFunction = "backspace()"; break;
					case "Clear": assFunction = "clearSearch()"; break;
					case "Space": assFunction = "space()"; break;
					default: assFunction = "";
				}
				
				if (assFunction != "") buttonElement.setAttribute("onclick", assFunction);
				
				cellElement.appendChild(buttonElement);
				
				rowElement.appendChild(cellElement);
			
				rowElement.setAttribute("class", "keyboardRow controlRow");
				
				newElement.appendChild(rowElement);
			}
			
			bottomPane.appendChild(newElement);
		}
		
		function generateKeyboard()
		{
			var bottomPane = document.getElementById("fullKeyboard");
			var newElement;
			
			var keyLayout = [["Q","W","E","R","T","Y","U","I","O","P"],
							 ["A","S","D","F","G","H","J","K","L"],
							 ["Z","X","C","V","B","N","M"]];
			
			newElement = document.createElement("DIV");
			
			newElement.setAttribute("id", "keyboard");
			
			for (var r = 0; r < keyLayout.length; r++)
			{
				var rowElement = document.createElement("DIV");
			
				for (var c = 0; c < keyLayout[r].length; c++)
				{
					var key = keyLayout[r][c];
					
					var cellElement = document.createElement("SPAN");
					
					cellElement.setAttribute("class", "keyboardCell");
					
					if (key != "")
					{
						var buttonElement = document.createElement("INPUT");
						buttonElement.setAttribute("type", "button");
						buttonElement.setAttribute("id", "key" + key.toUpperCase());
						buttonElement.setAttribute("value", key);
						buttonElement.setAttribute("class", "keyboardButton");
						buttonElement.setAttribute("onclick", "addToSearch(\"" + buttonElement.getAttribute("value") + "\")");
						
						cellElement.appendChild(buttonElement);
					}
					
					rowElement.appendChild(cellElement);
				}
				
				rowElement.setAttribute("class", "keyboardRow");
				
				newElement.appendChild(rowElement);
			}
			
			bottomPane.appendChild(newElement);
			
			generateKeyboardControlPanel();
		}
		</script>
	</head>
	<body>
		<table id="mainTable">
			<tr>
				<td class="pane" id="leftPane">
					<select id="albumList" class="dropdown" onchange="updateCenterPane()" size="22%">
					</select>
					<script>updateLeftPane()</script>
				</td>
				<td class="pane" id="centerPane">
					<select id="songList" class="dropdown" onchange="updateRightPane()" size="22%">
					</select>
					<script>updateCenterPane()</script>
				</td>
				<td class="pane" id="rightPane">
					<img id="albumArt">
					<p id="songName" class="songDetails"></p>
					<p id="songAlbum" class="songDetails"></p>
					<p id="songArtist" class="songDetails"></p>
					<audio controls id="audioControl" onended="nextSong()">
						<source id="sourceMP3" type="audio/mpeg">
						<source id="sourceWAV" type="audio/wav">
						Your browser does not support the audio element.
					</audio>
				</td>
			</tr>
			<tr>
				<td class="cell" id="bottomPane" colspan="3">
					<div>
						<input type="text" id="searchBar"></input>
						<select id="searchParameters">
							<option value="Title" selected>Title</option>
							<option value="Lyrics">Lyrics</option>
							<option value="TitleLyrics">Title & Lyrics</option>
						</select>
					</div>
					<div id="fullKeyboard">
						<script>generateKeyboard()</script>
					</div>
				</td>
			</tr>
		</table>
	</body>
</html>